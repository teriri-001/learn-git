# MongoDB基础

## mongodb相关概念

1. 应用场景

   1. 传统的关系型数据库难以支持的场景：
      1. 高并发读写
      2. 海量数据的高效存储
      3. 数据库的高扩展性和高可用性
   2. 适合使用MongoDB的数据特点
      1. 数据量大
      2. 读写操作频繁
      3. 数据价值低，对事物性要求不高

2. MongoDB简介

   1. 支持的数据结构松散，类似于JSON数据格式，称为BSON
   2. 是最像关系型数据库的非关系型数据库
   3. MongoDB不支持表连接，而使用嵌入式文档来代替多表连接
   4. MongoDB自动将==\_id==字段设置为主键
   5. MongoDB是无模式的，即没有明显的列

3. MongoDB体系结构

   |  mysql   |      MongoDB       |
   | :------: | :----------------: |
   |  数据库  |       数据库       |
   |    表    | 集合（collection） |
   | 一行数据 |  文档（document）  |

## 单机部署

1. Windows系统安装启动
   1. 下载MongoDB的安装包
   2. 版本选择：x.y.z，其中y为奇数表示开发版，y为偶数表示稳定版
   3. 配置环境变量
   4. 使用mongod命令启动
   5. 或者使用配置文件方式启动服务
2. shell连接mongoDB数据库
   1. 启动本地直接使用命令`mongo`
   2. 连接其他使用命令`mongo --host:ip地址 --port: 端口号`
3. 图形界面连接
   1. 使用软件compass

## 基本常用命令

### 数据库操作

1. 选择和创建数据库

   1. 存储机制：MongoDB存储分为两部分，创建数据库时，存放在内存中，只有当数据库中创建了集合之后，才会持久化到内存
   2. 命名规则：
      1. 应该全部小写

   ```sql
   // 如果不存在则会自动创建一个数据库
   use 数据库名称
   // 查看创建了的数据库
   show databases
   // 查看当前使用的数据库
   db
   ```

2. 删除数据库

   1. 默认删除当前选中的数据库，使用类似js的语法

   2. 主要是用于删除已经持久化到内存中的数据库

      ```sql
      db.dropDatabase()
      ```

### 集合操作

1. 集合的创建

   1. 显示创建（用得不多）

      ```sql
      db.createcollection(集合名称)
      // 查看集合
      show tables 或 show collections
      ```

   2. 隐式创建：当集合中插入一个文档时，如果该集合不存在，则会隐式创建一个集合

2. 集合的删除

   ```sql
   db.集合名称.drop()
   ```

### 文档的crud

1. 文档的插入

   1. 插入注意事项，如果插入时某一条数据插入失败，不会回滚，所以使用try catch捕捉失败信息

   ```sql
   // 单个插入使用insert()或save(),插入类似JSON对象的数据
   try{
   db.集合名称.insert(
   {
    "_id":"01",
    "name":"sinon",
    "age":18
   }
   )
   // 多个插入使用insertMany(),插入类似JSON对象数组的数据
   db.集合名称.insertMany({
     [
         {},{}
     ]                 
   })
   } catch(e){
   // 打印失败信息
   	print(e)
   }
   ```

2. 文档的基本查询

   1. 查询集合全部文档

      ```sql
      db.集合名称.find()
      ```

   2. 查询指定的文档

      ```sql
      db.集合名称.find({查询条件})
      ```

   3. 限制结果数量

      ```sql
      // 限制的是返回结果的上限为3，而非下限
      db.集合名称.find({}).limit(3)
      ```

   4. 限制返回的文档字段数

      ```sql
      // 则只返回指定的字段名，和默认的"_id"，可以指定其为0则强制不返回
      db.集合名称.find({查询条件},{字段名:1})
      ```

3. 文档的更新

   1. 语法 : `db.集合名称.update({query},{update},{options})`

      1. query：查询条件，查询出要修改的字段
      2. update：更新条件

   2. 覆盖的修改：删除原文档，把该文档修改为更新条件update中的字段

      ```sql
      // 如下修改，则文档中只剩一个name:"asuna"
      db.collectionName.update({_id:"01"},{name:"asuna"})
      ```

   3. 局部的修改：只修改指定的字段

      ```sql
      db.collectionName.update({_id:"01"},{$set:{name:"asuna"}})
      ```

   4. 批量的修改：默认只修改第一条字段，批量修改需要添加options条件

      ```sql
      // 添加条件multi:true
      db.collectionName.update({_id:"01"},{$set:{name:"asuna"}},{multi:true})
      ```

   5. 列值增长的修改：让某一字段的值每次修改则在原有值的基础上进行增加或减少

      ```sql
      // 使用$inc,如下每次age增长1
      db.collectionName.update({_id:"01"},{$inc:{age:1}})
      ```

4. 文档的删除

   ```sql
   // 删除条件为空则会删除全部
   db.集合名称.remove({删除条件})
   ```

### 文档的分页查询

1. 统计查询

   1. 语法：`db.集合名称.count(query,options)`

      1. query ：查询条件
      2. options：可选条件

   2. 示例

      ```sql
      // 不设条件则统计所有记录
      db.colletcion.count()
      ```

2. 分页列表查询

   1. 限制显示条数：使用limit()

      ```sql
      //只显示两条数据
      db.colletcion.find().limit(2)
      ```

   2. 设置起始显示条数：使用skip()

      ```sql
      // 跳过前面两条，显示之后两条
      db.colletcion.find().limit(2).skip(2)
      ```

3. 排序查询

   1. 在find()之后添加sort()进行排序查询
   2. sort({排序条件})，通过排序条件来设置依据什么排序，并使用1和-1来指定排序方式
      1. 正数1为升序
      2. 负数-1为降序
   3. 可以指定多个排序字段，越靠前排序优先级越高

### 复杂查询

1. 正则查询

   1. MongoDB的模糊查询是通过正则表达式的方式实现的格式如下：

      ```javascript
      db.集合名称.find({字段名:/正则表达式/})
      ```

2. 比较查询

   1. 比较操作符

      | 比较操作符 |    含义     |
      | :--------: | :---------: |
      |    $gt     |    大于     |
      |    $gte    |  大于等于   |
      |    $lt     |    小于     |
      |    $lte    |  小于等于   |
      |    $ne     |   不等于    |
      |  $in/$nin  | 包含/不包含 |

3. 条件连接查询

   1. 语法：`$条件(and,or) : [{条件1},{条件2}]`，对应的逻辑为`条件1 and 条件2`

## 索引-index

### 概述

1. 没有索引时，MongoDB查询时会扫描集合中的全部文档进行匹配
2. 设置索引之后，MongoDB会将建立索引的字段，以易于遍历的形式（B树)持久化存储，下次查询时，会首先查询索引，快速找到对应的文档位置信息，读取查询的文档

### 索引的类型

1. 单字段索引：在文档的单个字段上创建索引，单字段的索引键排序不重要
2. 复合索引：在文档的多个字段上定义索引，需要定义顺序，即文档在集合中的排序
3. 其他索引

### 索引的管理操作

1. 查看索引
   1. 语法：`db.collection.getIndexes()`
   2. 用于查询集合中的所有索引，集合默认创建了“\_id”的索引
2. 创建索引
   1. 语法：`db.collection.createIndex({name:1,age:-1})`
   2. 创建了name升序索引，age降序索引
3. 删除索引
   1. 语法：`db.collection.dropIndex(index)`
   2. index指索引名称或索引规范文档
   3. 删除所有索引：`db.collection.dropIndexes()`

### 索引的使用

1. 执行计划
   1. 用于分析查询性能，如查询时间、是否使用索引等
   2. 语法：`db.collection.find().explain()`
2. 涵盖的查询