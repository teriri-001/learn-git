# ffmpeg

## ffmpeg概述

1. 简介
   1. FFmpeg是一套可以用来记录、转换数字音频、视频，并能将其转化为流的开源计算机程序
2. 功能
   1. 音视频的截取和合并
   2. 实现视频的视频、音频分离提取
   3. 提取图片、制作gif等
3. 目录结构
   1. 如下图
   2. ffmpeg：音视频转码
   3. ffply：音视频播放
   4. ffprobe：查看多媒体文件的信息
   5. ![Snipaste_2020-08-28_23-13-21](C:\Users\yangyim\Pictures\snipaste\Snipaste_2020-08-28_23-13-21.png)

## 格式转换

1. 文件

   1. 格式：方便系统识别文件，并关联文件，让文件能够被相应的程序打开

   2. 封装：把编码器生成的内容，如音频、视频、字幕等按照一定的方式混合封装在一起

   3. 容器：存储这些音频、视频等的事物一般称为容器，用于为多媒体内容提供索引。不同的公司有不同的存储方式的容器，如avi、MP4等

   4. 常见视频封装格式

      |              视频封装格式              | 视频文件格式 | 特点                                     |
      | :------------------------------------: | :----------: | ---------------------------------------- |
      |                  AVI                   |     AVI      | 比较老的格式，不太适应新内容             |
      |                  WMV                   |     WMV      |                                          |
      | MPEG（分为MPEG1、MPEG2、MPEG3、MPEG4） |     MP4      | 当前最主流的封装格式                     |
      |                Matroska                |     MKV      | 最开放，几乎支持所有音视频，但是体积太大 |
      |               Real Vidio               |   RM RMVB    | 太封闭，只能用于封装Real Vidio的视频     |
      |         QuickTime File Format          |     MOV      | 当前主流的封装格式                       |
      |              Flash Video               |     FLV      |                                          |

   5. 视频格式转换

      1. 命令：

         ```dos
         ffmpeg -i input.mov output.mp4
         // -i : input缩写，用于指定输入文件
         ```
      
   6. 改变编码

      1. 编码：目的在于缩小文件体积

      2. 查看ffmpeg支持的编解码方式

         ```dos
         ffmpeg -codecs
         ```

      3. 主流封装：

         1. mp4封装 = H264视频编码 + AAC音频编码
         2. WebM封装 = VP8 + Vorbis (谷歌方案，不咋地)
         3. OGG封装 = theora + Vorbis （开源方案）

      4. 音频转码语法

         ```dos
         ffmpeg -i input.m4a -acodec -libmp31ame -ar 44100 -ab 320k -ac 2 -output.mp3
         // -acodec : 音频（audio）编解码器，指定音频编码器
         // -libmp31ame : mp3的音频编码器
         // -acodec -libmp31ame可以不指定，会根据最后的格式自动匹配
         // -ar : 设置音频采样率，一般为44100、48000。不写默认采用原音频采样率
         // -ab : 指定音频的比特率，不输入则默认128k
         // -ac : 设置声道数，1是单声道，2是双声道立体声。默认采用原音频声道数
         ```

      5. 视频分辨率压制

         ```dos
         ffmpeg -i input.mkv -s 1920x1080 -pix_fmt yuv420p -vcodec libx264 -preset medium -profile:v hige -level:v 4.1 -crf 23 -acodec aac -ar 44100 -ac 2 -b:a 128k output.mp4
         // -s : 用于缩放视频尺寸，设置新视频的分辨率
         // -pix_fmt : 设置视频颜色空间，根据视频要求做选择，可使用-pix_fmts查看ffmpeg支持的颜色空间（RGB、yuv420p。。）
         // -acodec : 视频（video）编解码器，一般用libx264
         // -preset : 编码器预设，即编码器性能的设置
         // -profile:v : 指定编码器的配置，和压缩比有关，一般实时通信采用baseline，流媒体采用main，自己制作的超清视频，则采用high
         // -level:v : 对编码器配置的具体规范，平衡压缩比和分辨率，一般1080p的视频用4.1
         // -crf : 设置码率控制模式，区间0~51,默认值23，数值越小画质越高，0即无损画质，不过一般再18~28之间选择
         // -r : 设置视频帧率
         // -b:a : 等同于-ab
         ```

      6. 码率控制模式

         1. 画质越好，要求的码率越高，文件体积越大

         2. 码率控制模式即决定为每一帧画面配多少比特数，即权衡文件体积和画面质量

         3. ffmpeg三种码率控制模式

            1. qp模式：常用于无损压缩，比特率恒定分布

               ```dos
               //快速编码方式
               ffmpeg -i input -vcodec libx264 -preset ultrafast -qb 0 output.mkv
               // 高压缩比方式
               ffmpeg -i input -vcodec libx264 -preset veryslow -qb 0 output.mkv
               ```

            2. crf模式: 推荐使用，比特率按画面特点分布

            3. b模式 ：用于码率和文件体积有限制的情况，一般不适用

      7. 合并、提取音视频

         1. 提取视频部分

            ```dos
            ffmpeg -i input.mp4 -vcodec copy -an output.mp4
            // -vcodec copy : 保持原编码格式
            // -an : 静音，实际上是音频剔除
            ```

         2. 提取音频部分

            ```dos
            ffmpeg -i input.mp4 -vn -acodec copy output.m4a
            // -vn ：剔除视频
            ```

         3. 视频中有多个音频流的情况

            1. 需要先使用查看视频信息的命令：`ffprobe input.mp4`
            2. 如果有多个音频流，则只能一一对应提取，使用参数`-map 指定音频流`进行提取

         4. 合并

            ```dos
            ffmpeg -i input1.mp4 -i input2.mp4 -c copy output.mp4
            // -c copy : 维持原编码器，如果合并的音视频编码方式不同则需用设置编码方式进行统一
            ```

      8. 截取、连接音视频

         1. 截取音视频

            ```dos
            ffmpeg -i input.mp3 -ss 开始时间 -to 结束时间 -acodec copy output.mp3
            // 时间的单位为秒，可以使用如下时间格式
            1. HH:MM:SS
            2. MM:SS
            3. SS
            // 其他截取方式: 将-to 改为 -t 截取时长
            // 第二种写法，使用关键帧技术，截取更快
            ffmpeg -ss 开始时间 -i input.mp4 -to 结束时间 -c copy -copyts output.mp4
            // copyts 保留时间戳，保证显示时间正确
            ```

         2. 连接音视频

            ```dos
            ffmpeg -i "concat: input1.mp4|input2.mp4..." -c copy output.mp4
            // -c copy : 维持原编码器，如果合并的音视频编码方式不同则需用设置编码方式进行统一
            //  上述方式用于视频参数（宽高、格式、码率等）一致，对于参数不一致的情况推荐使用开源软件 Avidemux
            ```

      9. 截图、水印、动图

         1. 截图：截取视频中的某一帧画面

            ```dos
            ffmpeg -i input.mp4 -ss 5 -vframes 1 output.jpg
            // -ss : 开始时间，上述即截取第五秒的视频画面
            // -vframes : 指定要一帧的画面，因为每一秒视频都是由多帧画面组成的
            ```

         2. 水印：给视频添加水印，需要视频和一个水印图片

            ```dos
            ffmpeg -i video.me4 -i img.jpg -filter_complex "overlay=20:20" output.mp4
            // -filter_complex : 添加滤镜，即img.jpg，需要设置位置
            // "overlay=20:20" : 即滤镜的位置在离左边20px,离顶部20px
            ```

         3. gif动图：即截取视频+设置分辨率+设置帧率+输出gif格式

         

